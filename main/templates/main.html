{% extends "base.html" %}
{% load static %}

{% block meta %}
<title>Footballpedia - Your Football Equipment Store</title>
{% endblock meta %}

{% block content %}
{% include "navbar.html" %}
{% include "toast.html" %}
{% include "modal.html" %}

<!-- Hero Section -->
<div class="bg-gradient-to-r from-green-500 to-green-600 text-white py-12">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center">
      <h1 class="text-4xl md:text-6xl font-bold mb-4">‚öΩ {{ application_name }}</h1>
      <p class="text-xl md:text-2xl mb-8">Your Ultimate Football Equipment Store</p>
      <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6 max-w-md mx-auto">
        <p class="text-lg"><span class="font-semibold">Welcome,</span> {{ user.username }}</p>
        <p class="text-sm opacity-90">Last login: {{ last_login|slice:":16" }}</p>
      </div>
    </div>
  </div>
</div>

<!-- Action Buttons -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="flex flex-col sm:flex-row gap-4 justify-center mb-8">
    <button onclick="showModal()" class="btn-football text-white px-6 py-3 rounded-lg font-semibold text-center hover:shadow-lg transition-all">
      ‚ûï Add New Product
    </button>
    <div class="flex gap-2">
      <button id="filter-all" onclick="setFilter('all')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg font-medium transition-colors">
        All Products
      </button>
      <button id="filter-my" onclick="setFilter('my')" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-3 rounded-lg font-medium transition-colors">
        My Products
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div id="loading" class="hidden text-center py-16">
    <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-green-500"></div>
    <p class="mt-4 text-gray-600 font-medium">Loading products...</p>
  </div>

  <!-- Error State -->
  <div id="error" class="hidden text-center py-16">
    <div class="max-w-md mx-auto">
      <div class="text-6xl mb-4">‚ö†Ô∏è</div>
      <h3 class="text-2xl font-bold text-gray-700 mb-4">Error Loading Products</h3>
      <p class="text-gray-500 mb-8">Something went wrong. Please try again.</p>
      <button onclick="loadProducts()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold">
        Retry
      </button>
    </div>
  </div>

  <!-- Empty State -->
  <div id="empty" class="hidden text-center py-16">
    <div class="max-w-md mx-auto">
      <div class="mb-6">
        <img src="{% static 'image/no-product.png' %}" alt="No products" class="w-32 h-32 mx-auto">
      </div>
      <h3 class="text-2xl font-bold text-gray-700 mb-4">No Products Yet</h3>
      <p class="text-gray-500 mb-8">Be the first to add football equipment to our store!</p>
      <button onclick="showModal()" class="btn-football text-white px-8 py-4 rounded-lg font-semibold inline-block">
        Add First Product
      </button>
    </div>
  </div>

  <!-- Product Grid -->
  <div id="grid" class="hidden"></div>
</div>

<script>
const CURRENT_USER_ID = "{{ user.id }}";
let currentFilter = 'all';

function setFilter(filter) {
  currentFilter = filter;
  const allBtn = document.getElementById('filter-all');
  const myBtn = document.getElementById('filter-my');
  
  if (filter === 'all') {
    allBtn.classList.add('ring-2', 'ring-blue-300');
    myBtn.classList.remove('ring-2', 'ring-purple-300');
  } else {
    myBtn.classList.add('ring-2', 'ring-purple-300');
    allBtn.classList.remove('ring-2', 'ring-blue-300');
  }
  
  loadProducts();
}

function showSection(section) {
  ['loading', 'error', 'empty', 'grid'].forEach(id => {
    document.getElementById(id).classList.add('hidden');
  });
  document.getElementById(section).classList.remove('hidden');
  
  if (section === 'grid') {
    document.getElementById('grid').className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6';
  }
}

async function loadProducts() {
  showSection('loading');
  
  try {
    const response = await fetch("{% url 'main:show_json' %}");
    if (!response.ok) throw new Error('Failed to fetch');
    
    const products = await response.json();
    const filtered = currentFilter === 'all' 
      ? products 
      : products.filter(p => p.user_id == CURRENT_USER_ID);
    
    if (filtered.length === 0) {
      showSection('empty');
      return;
    }
    
    const grid = document.getElementById('grid');
    grid.innerHTML = filtered.map(product => createProductCard(product)).join('');
    showSection('grid');
  } catch (error) {
    console.error('Error loading products:', error);
    showSection('error');
  }
}

function createProductCard(product) {
  const detailUrl = `/product/${product.id}/`;
  const editUrl = `/product/${product.id}/edit`;
  const deleteUrl = `/product/${product.id}/delete`;
  
  const categoryNames = {
    'footwear': 'Footwear',
    'jersey': 'Jersey',
    'shin guard': 'Shin Guard',
    'gloves': 'Gloves',
    'other': 'Other'
  };
  
  const thumbnail = product.thumbnail 
    ? `<img src="${product.thumbnail}" alt="${product.name}" class="w-full h-full object-cover">`
    : `<div class="w-full h-full flex items-center justify-center text-6xl text-gray-400">‚öΩ</div>`;
  
  const featuredBadge = product.is_featured 
    ? `<div class="absolute top-2 right-2 bg-yellow-400 text-yellow-900 px-2 py-1 rounded-full text-xs font-bold">‚≠ê Featured</div>`
    : '';
  
  const actionButtons = product.user_id == CURRENT_USER_ID
    ? `<a href="${editUrl}" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-3 rounded-lg text-sm font-medium transition-colors">‚úèÔ∏è</a>
       <a href="${deleteUrl}" class="bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded-lg text-sm font-medium transition-colors" onclick="return confirm('Are you sure?')">üóëÔ∏è</a>`
    : '';
  
  return `
    <div class="bg-white rounded-xl shadow-md card-hover overflow-hidden">
      <div class="h-48 bg-gray-100 relative overflow-hidden">
        ${thumbnail}
        ${featuredBadge}
      </div>
      <div class="p-4">
        <div class="flex items-center justify-between mb-2">
          <span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-1 rounded-full">
            ${categoryNames[product.category] || product.category}
          </span>
          <div class="flex items-center text-sm text-gray-600">
            <span class="text-yellow-500">‚≠ê</span>
            <span class="ml-1">${product.rating}</span>
          </div>
        </div>
        <h3 class="font-bold text-lg text-gray-800 mb-2 line-clamp-2">
          <a href="${detailUrl}" class="hover:text-green-600 transition-colors">${product.name}</a>
        </h3>
        <p class="text-gray-600 text-sm mb-3 line-clamp-2">${product.description}</p>
        <div class="flex items-center justify-between mb-4">
          <span class="text-2xl font-bold text-green-600">Rp ${parseInt(product.price).toLocaleString('id-ID')}</span>
          <span class="text-sm text-gray-500">${product.quantity} sold</span>
        </div>
        <div class="flex gap-2">
          <a href="${detailUrl}" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-3 rounded-lg text-sm font-medium text-center transition-colors">
            View Details
          </a>
          ${actionButtons}
        </div>
      </div>
    </div>
  `;
}

document.addEventListener('DOMContentLoaded', () => {
  loadProducts();
  
  {% if messages %}
    {% for message in messages %}
      showToast('{{ message.tags|title }}', '{{ message }}', '{{ message.tags }}');
    {% endfor %}
  {% endif %}
});

document.addEventListener('productAdded', loadProducts);
</script>
{% endblock content %}
